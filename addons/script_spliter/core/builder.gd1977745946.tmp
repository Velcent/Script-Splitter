@tool
extends RefCounted
const EditorManager = preload("res://addons/script_spliter/core/editor/godot/manager.gd")
const BaseContainer = preload("res://addons/script_spliter/core/base/container.gd")
const BaseList = preload("res://addons/script_spliter/core/base/list.gd")

var _plugin : EditorPlugin = null
var _editor_manager : EditorManager = null


#region _REF_
var _item_list : ItemList = null:
	get:
		if !is_instance_valid(_item_list):
			var script_editor: ScriptEditor = EditorInterface.get_script_editor()
			var items : Array[Node] = script_editor.find_children("*", "ItemList", true, false)
			if items.size() > 0:
				_item_list =  items[0]
			else:
				push_warning("[Script-Spliter] Can not find item list!")
		return _item_list
#endregion

func handle(id : StringName) -> void:
	_editor_manager.io.execute(id)
	
func refresh_warnings() -> void:
	_editor_manager.refresh_warnings.execute()
	
func can_split(values : Variant) -> bool:
	var current : Node = null
	if values is PackedStringArray and values.size() > 0:
		var root : Node = _plugin.get_tree().root
		if root.has_node(values[0]):
			current = root.get_node(values[0])
	return _editor_manager.get_current_totaL_editors(current) > 1
	
func can_merge_column(values : Variant) -> bool:
	var current : Node = null
	if values is PackedStringArray and values.size() > 0:
		var root : Node = _plugin.get_tree().root
		if root.has_node(values[0]):
			current = root.get_node(values[0])
	return _editor_manager.get_current_total_splitters(current) > 1
	
func can_merge_row(_values : Variant) -> bool:
	#var current : Node = null
	#if values is PackedStringArray and values.size() > 0:
		#var root : Node = _plugin.get_tree().root
		#if root.has_node(values[0]):
			#current = root.get_node(values[0])
	return _editor_manager.get_total_split_container(true) > 1
	
func can_left_tab_close(values : Variant) -> bool:
	if values is PackedStringArray and values.size() > 0:
		var root : Node = _plugin.get_tree().root
		if root.has_node(values[0]):
			values = root.get_node(values[0])
		else:
			values = values[0]
	var node : Node = _editor_manager.get_control_tool_by_current(values)
	return node and node.get_index() > 0
	
func can_right_tab_close(values : Variant) -> bool:
	if values is PackedStringArray and values.size() > 0:
		var root : Node = _plugin.get_tree().root
		if root.has_node(values[0]):
			values = root.get_node(values[0])
		else:
			values = values[0]
	var node : Node = _editor_manager.get_control_tool_by_current(values)
	return node and node.get_index() < node.get_parent().get_child_count() - 1
	
func can_others_tab_close(values : Variant) -> bool:
	if values is PackedStringArray and values.size() > 0:
		var root : Node = _plugin.get_tree().root
		if root.has_node(values[0]):
			values = root.get_node(values[0])
		else:
			values = values[0]
	var node : Node = _editor_manager.get_control_tool_by_current(values)
	return node and node.get_parent().get_child_count() > 1
	
func update(_delta : float) -> void:
	if _editor_manager.update():
		_plugin.set_process(false)
	
	
func init_0() -> void:
	if is_instance_valid(_editor_manager):
		_editor_manager.reset()
	#_control_container.queue_free()
	_editor_manager = null
	#_control_container = null
	
func connect_callbacks(
	on_column : Signal, 
	on_row : Signal, 
	out_column : Signal, 
	out_row : Signal, 
	left_tab_close : Signal, 
	right_tab_close : Signal, 
	others_tab_close : Signal,
	
	do_connect : bool = true) -> void:
	for x : Array in [
		[on_column, _editor_manager.split_column.execute],
		[on_row, _editor_manager.split_row.execute],
		[out_column, _editor_manager.unsplit_column],
		[out_row, _editor_manager.unsplit_row],
		[left_tab_close, _editor_manager.left_tab_close],
		[right_tab_close, _editor_manager.right_tab_close],
		[others_tab_close, _editor_manager.others_tab_close]
		]:
		if !x[0].is_null():
			if do_connect:
				if !x[0].is_connected(x[1]):
					x[0].connect(x[1])
			else:
				if x[0].is_connected(x[1]):
					x[0].disconnect(x[1])
func _nws() -> void:
	pass
	
func _clean_settings() -> void:
	var e : EditorSettings = EditorInterface.get_editor_settings()
	if e.has_setting("plugin/script_spliter/rows"):
		_nws()
		return
		e.set_setting("plugin/script_spliter/rows", null)
		e.set_setting("plugin/script_spliter/columns", null)
		e.set_setting("plugin/script_spliter/save_rows_columns_count_on_exit", null)
		e.set_setting("plugin/script_spliter/window/use_highlight_selected", null)
		e.set_setting("plugin/script_spliter/window/highlight_selected_color", null)
		e.set_setting("plugin/script_spliter/editor/split/reopen_last_closed_editor_on_add_split", null)
		e.set_setting("plugin/script_spliter/editor/split/remember_last_used_editor_buffer_size", null)
		
		for x : int in range(1, 11, 1):
			e.set_setting(str("plugin/script_spliter/input/split_type_" , x), null)
		
	
func init_1(plugin : EditorPlugin, tab_container : TabContainer, item_list : ItemList) -> void:
	if !is_instance_valid(plugin) or !is_instance_valid(tab_container):
		printerr("Error, can`t initalize plugin, not valid references!")
		return
		
	_clean_settings()
	_plugin = plugin
	_plugin.set_process(true)
	
	_editor_manager = EditorManager.new(BaseContainer.new(tab_container), BaseList.new(item_list))
	_editor_manager.update_request.connect(_queue_update)
	
func _queue_update() -> void:
	_plugin.set_process(true)
